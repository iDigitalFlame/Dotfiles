#!/usr/bin/bash
################################
###### iDigitalFlame 2018 ######
#                              #
#            -/`               #
#            -yy-   :/`        #
#         ./-shho`:so`         #
#    .:- /syhhhh//hhs` `-`     #
#   :ys-:shhhhhhshhhh.:o- `    #
#   /yhsoshhhhhhhhhhhyho`:/.   #
#   `:yhyshhhhhhhhhhhhhh+hd:   #
#     :yssyhhhhhyhhhhhhhhdd:   #
#    .:.oyshhhyyyhhhhhhddd:    #
#    :o+hhhhhyssyhhdddmmd-     #
#     .+yhhhhyssshdmmddo.      #
#       `///yyysshd++`         #
#                              #
########## SPACEPORT ###########
################################
## SMB Connect
# iDigitalFlame

if [ $# -lt 2 ]; then
  printf "smb-connect [-f] <username> <share_path>\n"
  exit 1
fi

if [ $# -eq 3 ]; then
    smbusr="$2"
    smbshare="$3"
else
    smbusr="$1"
    smbshare="$2"
fi
if [ ! -z "$(echo $smbusr | grep '/')" ]; then
    smbdom=$(echo $smbusr | awk -F'/' '{print $1}')
    smbusr=$(echo $smbusr | awk -F'/' '{print $2}')
else
    smbdom=""
fi
smbfldr=$(echo "$smbshare" | awk -F'/' '{print $NF}')
smbwkrg=$(echo "$smbdom" | awk -F'.' '{print $1}')
if [ $# -eq 3 ];then
    printf "" | gnome-keyring-query set smb-connect-$smbwkrg-$smbusr
    smbpwd=""
else
    smbpwd=$(gnome-keyring-query get smb-connect-$smbwkrg-$smbusr)
fi
while [ -z "$smbpwd" ]; do
    printf "Password: "
    read -s smbpwd
done
if [ -z "$smbpwd" ]; then
    printf "A password is required!\n"
    exit 1
fi
printf "$smbpwd" | gnome-keyring-query set smb-connect-$smbwkrg-$smbusr
smbmnt="/tmp/.mounts/$USER/smb-$(echo $smbfldr | sed -e 's/\$//g')"
if [ ! -z "$(mount | grep $smbmnt)" ]; then
    printf "\"$smbmnt\" is already mounted!\n"
    exit 1
fi
if [ ! -d "$smbmnt" ]; then
    mkdir -p "$smbmnt"
fi
sudo /opt/spaceport/sbin/smb-mount "$smbshare" "$smbmnt" "vers=3.0,username=\"$smbusr\",domain=\"$smbdom\",workgroup=\"$smbwkrg\",password=\"$smbpwd\",uid=$USER,gid=$USER,file_mode=0750,dir_mode=0750"
if [ $? -ne 0 ]; then
    printf "There was a problem mounting \"$smbshare\"!\n"
else
    printf "\"$smbshare\" mounted to \"$smbmnt\"\n"
fi
smbpwd=""
smbdom=""
smbusr=""
unset smbpwd
unset smbdom
unset smbusr
exit 0
