#!/usr/bin/bash
################################
###### iDigitalFlame 2020 ######
#                              #
#            -/`               #
#            -yy-   :/`        #
#         ./-shho`:so`         #
#    .:- /syhhhh//hhs` `-`     #
#   :ys-:shhhhhhshhhh.:o- `    #
#   /yhsoshhhhhhhhhhhyho`:/.   #
#   `:yhyshhhhhhhhhhhhhh+hd:   #
#     :yssyhhhhhyhhhhhhhhdd:   #
#    .:.oyshhhyyyhhhhhhddd:    #
#    :o+hhhhhyssyhhdddmmd-     #
#     .+yhhhhyssshdmmddo.      #
#       `///yyysshd++`         #
#                              #
########## SPACEPORT ###########
################################
## System Update Wrapper
#
# Copyright (C) 2020 iDigitalFlame
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.
#

hosts_file="/etc/hosts"
if [ -f "$HOME/.local/apps/updateHosts/updateHostsFile.py" ]; then
    if [ ! -z "$(cd $HOME/.local/apps/updateHosts; sg firewall-web 'git pull' | grep -v "Already up to date")" ]; then
        printf "[+] Grabbing updates to codebase...\n"
        sg firewall-web -c "cd $HOME/.local/apps/updateHosts; git stash; git pull"
    fi
    printf "[+] Updating hosts blocklist file...\n"
    sg firewall-web -c "/usr/bin/python3 $HOME/.local/apps/updateHosts/updateHostsFile.py --auto --compress --minimise"
    hosts_file="$HOME/.local/apps/updateHosts/hosts"
fi

hosts_list=$(cat<<EOD
127.0.0.1 cups
127.0.0.1 hydra
127.0.0.1 www.facebook.com
127.0.0.1 facebook.com
127.0.0.1 login.facebook.com
127.0.0.1 www.login.facebook.com
127.0.0.1 fbcdn.net
127.0.0.1 www.fbcdn.net
127.0.0.1 fbcdn.com
127.0.0.1 www.fbcdn.com
127.0.0.1 static.ak.fbcdn.net
127.0.0.1 static.ak.connect.facebook.com
127.0.0.1 connect.facebook.net
127.0.0.1 www.connect.facebook.net
127.0.0.1 apps.facebook.com
::1 www.facebook.com
::1 facebook.com
::1 login.facebook.com
::1 www.login.facebook.com
::1 fbcdn.net
::1 www.fbcdn.net
::1 fbcdn.com
::1 www.fbcdn.com
::1 static.ak.fbcdn.net
::1 static.ak.connect.facebook.com
::1 connect.facebook.net
::1 www.connect.facebook.net
::1 apps.facebook.com
EOD
)
sg firewall-web -c "curl -sL https://www.github.developerdan.com/hosts/lists/facebook-extended.txt -o /tmp/fbhosts1.txt"
sg firewall-web -c "curl -sL https://raw.githubusercontent.com/jmdugan/blocklists/master/corporations/facebook/all -o /tmp/fbhosts2.txt"
sg firewall-web -c "curl -sL https://raw.githubusercontent.com/jmdugan/blocklists/master/corporations/pinterest/all -o /tmp/fbhosts3.txt"
cat /tmp/fbhosts1.txt /tmp/fbhosts2.txt /tmp/fbhosts3.txt > /tmp/fbhosts.txt

printf "[+] Starting pacman...\n"
sudo sh -c "sg firewall-web -c '/usr/bin/sysupdate'; sync; cp '$hosts_file' /etc/hosts; printf '\n$hosts_list\n' >> /etc/hosts; cat /tmp/fbhosts.txt >> /etc/hosts"
rm -f /tmp/fbhosts*.txt 2> /dev/null
printf "[+] Starting yay...\n"
sg firewall-web -c "/usr/bin/yay -Syua --answerclean N"
printf "[+] Updating PIP packages...\n"
sg firewall-web -c "pip list --outdated --format=freeze | grep -v '^\-e' | cut -d = -f 1  | xargs -n1 pip install -U" 2>&1 |grep -v 'least one requirement to install (see "pip help install")'
sudo syslink
