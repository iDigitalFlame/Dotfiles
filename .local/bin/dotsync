#!/usr/bin/dash
################################
### iDigitalFlame  2016-2024 ###
#                              #
#            -/`               #
#            -yy-   :/`        #
#         ./-shho`:so`         #
#    .:- /syhhhh//hhs` `-`     #
#   :ys-:shhhhhhshhhh.:o- `    #
#   /yhsoshhhhhhhhhhhyho`:/.   #
#   `:yhyshhhhhhhhhhhhhh+hd:   #
#     :yssyhhhhhyhhhhhhhhdd:   #
#    .:.oyshhhyyyhhhhhhddd:    #
#    :o+hhhhhyssyhhdddmmd-     #
#     .+yhhhhyssshdmmddo.      #
#       `///yyysshd++`         #
#                              #
########## SPACEPORT ###########
## Permissions and Links Reset
#
# Copyright (C) 2016 - 2024 iDigitalFlame
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.
#

# Enable Strict Mode
set -u

DOTS="${HOME}/.dotfiles"

echo "Updating dotfiles.."
chmod -R 0550 "${DOTS}"
find "${DOTS}" -xdev -type f -exec chmod 0440 {} \;

chmod 0550 "${DOTS}/.zshrc"
chmod -R 0770 "${DOTS}/.git"
chmod -R 0550 "${DOTS}/.local/bin"

chmod 0640 "${DOTS}/.config/smd.json"
chmod 0640 "${DOTS}/.config/quotes.db"
chmod 0640 "${DOTS}/dotfiles.code-workspace"

relink "$DOTS" "${HOME}"

rm -f "${HOME}/.config/cubocore/pins"
rm -f "${HOME}/.config/cubocore/activities"
rm -f "${HOME}/.local/bin/firefox" 2> /dev/null
rm -f "${HOME}/.local/bin/librewolf" 2> /dev/null
rm -f "${HOME}/.config/mimeapps.list" 2> /dev/null
rm -f "${HOME}/.config/librewolf/chrome" 2> /dev/null
rm -f "${HOME}/.local/bin/x-www-browser" 2> /dev/null
rm -f "${HOME}/.local/share/mimeapps.list" 2> /dev/null
rm -f "${HOME}/.local/share/applications/discord.desktop" 2> /dev/null
rm -f "${HOME}"/.local/share/applications/userapp*.desktop 2> /dev/null

ln -sT "/dev/null" "${HOME}/.config/cubocore/pins"
ln -sT "/dev/null" "${HOME}/.config/cubocore/activities"
ln -sT "${HOME}/.local/bin/browser" "${HOME}/.local/bin/firefox"
ln -sT "${HOME}/.local/bin/browser" "${HOME}/.local/bin/librewolf"
ln -sT "${HOME}/.local/bin/browser" "${HOME}/.local/bin/x-www-browser"
ln -sT "${HOME}/.config/mozilla/firefox/chrome" "${HOME}/.config/librewolf/chrome"
ln -sT "${DOTS}/.local/share/applications/mimeapps.list" "${HOME}/.config/mimeapps.list"
ln -sT "${DOTS}/.local/share/applications/mimeapps.list" "${HOME}/.local/share/mimeapps.list"

chmod 0750 "${HOME}/.dvm/bin/discord"
chmod 0750 "${HOME}/.dvm/Discord/Discord"
chmod 0750 "${HOME}"/.local/lib/oh-my-zsh/tools/*.sh

dash "${HOME}/.private/sync.sh"
themectl reload

# Reset SetGID bit on files
find "${DOTS}" -xdev -type d -exec chmod g+s {} \;

echo "Broken Links Found:"
find "${HOME}" -xtype l -xdev 2> /dev/null

echo "Done!"
exit 0
